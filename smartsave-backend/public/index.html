<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vault</title>

  <!-- Optional: If you want true Excel .xlsx export, keep this CDN.
       If you don't want any CDN, remove it and CSV export will still work. -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* Minimal clean styling scaffold.
       If you already have your beautiful CSS, replace this with your old styles. */

    :root {
      --bg: #07090d;
      --panel: rgba(255,255,255,.04);
      --panel2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.55);
      --accent: #d8a62a;
      --good: #2fdc8c;
      --bad: #ff5b6a;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 30% 0%, rgba(216,166,42,.12), transparent 55%),
                  radial-gradient(900px 600px at 75% 30%, rgba(47,220,140,.08), transparent 50%),
                  var(--bg);
      color: var(--text);
    }

    a { color: inherit; text-decoration: none; }
    button, input, select { font: inherit; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }

    /* Top bar */
    .topbar {
      position: sticky; top: 0; z-index: 20;
      backdrop-filter: blur(10px);
      background: rgba(7,9,13,.65);
      border-bottom: 1px solid var(--border);
    }
    .topbar-inner {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; padding: 14px 20px;
      max-width: 1200px; margin: 0 auto;
    }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; letter-spacing: .12em; }
    .brand-badge {
      width: 34px; height: 34px; border-radius: 9px;
      border: 1px solid var(--border);
      display: grid; place-items: center;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    }
    .nav {
      display: flex; align-items: center; gap: 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px;
      background: rgba(255,255,255,.03);
    }
    .tab {
      padding: 8px 14px;
      border-radius: 999px;
      color: var(--muted);
      cursor: pointer;
      user-select: none;
      transition: .15s ease;
    }
    .tab.active {
      color: var(--text);
      border: 1px solid rgba(216,166,42,.35);
      background: rgba(216,166,42,.10);
    }
    .actions { display: flex; gap: 10px; align-items: center; }
    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 13px;
    }
    .btn {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      transition: .15s ease;
    }
    .btn:hover { background: rgba(255,255,255,.07); }
    .btn.primary {
      border-color: rgba(216,166,42,.45);
      background: rgba(216,166,42,.12);
      color: #fff;
    }
    .btn.danger {
      border-color: rgba(255,91,106,.45);
      background: rgba(255,91,106,.10);
    }

    /* Cards / layout */
    .hero { padding: 22px 0 14px; }
    .title { font-size: 40px; letter-spacing: .02em; margin: 0 0 8px; }
    .subtitle { color: var(--muted); letter-spacing: .18em; font-size: 12px; text-transform: uppercase; }
    .grid5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
    .grid2 { display: grid; grid-template-columns: 2fr 1.2fr; gap: 12px; }
    .grid3 { display: grid; grid-template-columns: 1.2fr 1.2fr 1fr; gap: 12px; }

    @media (max-width: 1100px) {
      .grid5 { grid-template-columns: repeat(2, 1fr); }
      .grid2 { grid-template-columns: 1fr; }
      .grid3 { grid-template-columns: 1fr; }
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      padding: 16px;
      min-height: 70px;
    }
    .card h3 {
      margin: 0 0 12px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .14em;
      color: rgba(255,255,255,.75);
      display: flex; justify-content: space-between; align-items: center;
      gap: 10px;
    }
    .metric {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: .02em;
    }
    .muted { color: var(--muted); }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .field { display: grid; gap: 6px; margin: 10px 0; }
    .field label { font-size: 12px; text-transform: uppercase; letter-spacing: .14em; color: var(--muted); }
    input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.35);
      color: var(--text);
      outline: none;
    }
    input:focus, select:focus { border-color: rgba(216,166,42,.55); }

    .seg {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255,255,255,.03);
    }
    .seg button {
      border: 0;
      background: transparent;
      color: var(--muted);
      padding: 10px 12px;
      cursor: pointer;
    }
    .seg button.active {
      background: rgba(255,255,255,.06);
      color: var(--text);
    }

    .list { display: grid; gap: 10px; }
    .item {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .item .left { display: grid; gap: 2px; }
    .item .name { font-weight: 650; }
    .item .meta { font-size: 12px; color: var(--muted); }
    .amount.bad { color: var(--bad); font-weight: 700; }
    .amount.good { color: var(--good); font-weight: 700; }
    .amount.neutral { color: rgba(255,255,255,.85); font-weight: 700; }

    .hide { display: none !important; }

    /* Auth overlay */
    .auth {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 30px;
    }
    .auth-card {
      width: min(520px, 100%);
      border: 1px solid var(--border);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      padding: 18px;
    }
    .auth-head { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    .auth-head h2 { margin: 0; letter-spacing: .12em; text-transform: uppercase; font-size: 14px; color: rgba(255,255,255,.85); }
    .note { font-size: 13px; color: var(--muted); line-height: 1.5; }
    .err { color: var(--bad); font-size: 13px; }
    .ok { color: var(--good); font-size: 13px; }

    canvas { width: 100%; height: 240px; border-radius: 14px; background: rgba(255,255,255,.02); border: 1px solid var(--border); }
  </style>
</head>

<body>
  <!-- AUTH VIEW -->
  <div id="authView" class="auth">
    <div class="auth-card">
      <div class="auth-head">
        <div class="brand">
          <div class="brand-badge">◻︎</div>
          <div>VAULT</div>
        </div>
        <div class="row">
          <button class="btn" id="switchAuthBtn">Switch to Sign up</button>
        </div>
      </div>

      <p class="note" style="margin-top:10px">
        Sign in to your Vault. Your data is stored securely on the server (not local storage).
      </p>

      <div id="authMsg" class="err hide"></div>

      <div class="field" id="nameField" class="hide">
        <label>Name (Sign up only)</label>
        <input id="authName" placeholder="Your name" autocomplete="name" />
      </div>

      <div class="field">
        <label>Email</label>
        <input id="authEmail" placeholder="you@example.com" autocomplete="email" />
      </div>

      <div class="field">
        <label>Password</label>
        <input id="authPassword" type="password" placeholder="••••••••" autocomplete="current-password" />
      </div>

      <div class="row" style="justify-content: space-between; margin-top: 12px;">
        <button class="btn primary" id="authSubmitBtn">Login</button>
        <span class="note">Tip: if it fails, open DevTools → Network.</span>
      </div>
    </div>
  </div>

  <!-- APP VIEW -->
  <div id="appView" class="hide">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="brand-badge">◻︎</div>
          <div>VAULT</div>
        </div>

        <div class="nav" role="tablist">
          <div class="tab active" data-tab="dashboard">Dashboard</div>
          <div class="tab" data-tab="recurring">Recurring</div>
          <div class="tab" data-tab="planning">Planning</div>
        </div>

        <div class="actions">
          <div class="pill" id="aiStatus">AI: idle</div>
          <button class="btn" id="exportBtn">Export</button>
          <button class="btn danger" id="logoutBtn">Logout</button>
        </div>
      </div>
    </div>

    <div class="wrap">
      <div class="hero">
        <h1 class="title" id="welcomeTitle">Welcome</h1>
        <div class="subtitle" id="todayLine"></div>
      </div>

      <!-- DASHBOARD -->
      <section id="tab-dashboard">
        <div class="grid5">
          <div class="card">
            <h3>Available <span class="muted">Spendable</span></h3>
            <div class="metric" id="mAvailable">$0.00</div>
          </div>
          <div class="card">
            <h3>Savings <span class="muted">Reserved</span></h3>
            <div class="metric" id="mSavings">$0.00</div>
          </div>
          <div class="card">
            <h3>Budget <span class="muted">Monthly</span></h3>
            <div class="metric" id="mBudget">$0.00</div>
          </div>
          <div class="card">
            <h3>Spent <span class="muted">This month</span></h3>
            <div class="metric" id="mSpent">$0.00</div>
          </div>
          <div class="card">
            <h3>Committed <span class="muted">Recurring</span></h3>
            <div class="metric" id="mCommitted">$0.00</div>
          </div>
        </div>

        <div style="height: 12px"></div>

        <div class="grid2">
          <div class="card">
            <h3>
              Spending Breakdown
              <span class="muted" id="breakdownHint">Loading…</span>
            </h3>
            <canvas id="donut"></canvas>
          </div>

          <div class="card">
            <h3>Recent Activity <span class="muted" id="txHint"></span></h3>
            <div id="recentList" class="list">
              <div class="muted">Loading…</div>
            </div>
          </div>
        </div>

        <div style="height: 12px"></div>

        <div class="grid3">
          <div class="card">
            <h3>Record Transaction</h3>

            <div class="seg" style="margin-bottom:10px">
              <button class="active" data-mode="expense" id="modeExpense">Expense</button>
              <button data-mode="income" id="modeIncome">Income</button>
              <button data-mode="save" id="modeSave">Save</button>
            </div>

            <div class="field">
              <label>Category</label>
              <input id="txCategory" placeholder="Food & Dining" />
            </div>

            <div class="field">
              <label>Amount</label>
              <input id="txAmount" type="number" step="0.01" placeholder="0.00" />
            </div>

            <div class="field">
              <label>Date</label>
              <input id="txDate" type="date" />
            </div>

            <div class="field">
              <label>Note (optional)</label>
              <input id="txNote" placeholder="e.g. dinner with friends" />
            </div>

            <div class="row" style="justify-content: space-between; margin-top: 8px;">
              <button class="btn primary" id="addTxBtn">Add</button>
              <div id="txMsg" class="err hide"></div>
            </div>
          </div>

          <div class="card">
            <h3>AI Insights <span class="muted">Server-generated</span></h3>
            <div id="insightsBox" class="list">
              <div class="muted">Loading…</div>
            </div>
          </div>

          <div class="card">
            <h3>Period</h3>
            <div class="field">
              <label>From</label>
              <input id="fromDate" type="date" />
            </div>
            <div class="field">
              <label>To</label>
              <input id="toDate" type="date" />
            </div>
            <div class="row" style="justify-content: space-between;">
              <button class="btn primary" id="applyPeriodBtn">Apply</button>
              <button class="btn" id="resetPeriodBtn">Reset</button>
            </div>
            <p class="note" style="margin-top: 10px;">
              Period filters dashboard charts + recent activity.
            </p>
          </div>
        </div>
      </section>

      <!-- RECURRING -->
      <section id="tab-recurring" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Add Recurring Expense</h3>

            <div class="field">
              <label>Name</label>
              <input id="rName" placeholder="Netflix" />
            </div>
            <div class="field">
              <label>Amount</label>
              <input id="rAmount" type="number" step="0.01" placeholder="0.00" />
            </div>
            <div class="field">
              <label>Frequency</label>
              <select id="rFrequency">
                <option value="monthly">Monthly</option>
                <option value="weekly">Weekly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
            <div class="field">
              <label>Due Day (optional)</label>
              <input id="rDueDay" type="number" min="1" max="31" placeholder="1" />
            </div>

            <div class="row" style="justify-content: space-between;">
              <button class="btn primary" id="addRecurringBtn">Add Recurring</button>
              <div id="rMsg" class="err hide"></div>
            </div>
          </div>

          <div class="card">
            <h3>Recurring List <span class="muted" id="rHint"></span></h3>
            <div id="recurringList" class="list">
              <div class="muted">Loading…</div>
            </div>
          </div>
        </div>
      </section>

      <!-- PLANNING -->
      <section id="tab-planning" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Set Monthly Budget</h3>

            <div class="field">
              <label>Monthly Budget</label>
              <input id="budgetValue" type="number" step="0.01" placeholder="2000.00" />
            </div>

            <div class="row" style="justify-content: space-between;">
              <button class="btn primary" id="saveBudgetBtn">Save Budget</button>
              <div id="bMsg" class="err hide"></div>
            </div>

            <p class="note" style="margin-top:12px">
              Budget is stored per user on the server.
            </p>
          </div>

          <div class="card">
            <h3>Budget Summary</h3>
            <div class="list" id="budgetSummary">
              <div class="muted">Loading…</div>
            </div>
          </div>
        </div>
      </section>

      <div style="height: 30px"></div>
    </div>
  </div>

  <script>
    // =========================
    // State + Helpers
    // =========================
    const API_URL = `${window.location.origin}/api`;

    const state = {
      token: localStorage.getItem('token') || null,
      user: null,
      period: { from: null, to: null },
      transactions: [],
      recurring: [],
      metrics: null,
      insights: []
    };

    const $ = (id) => document.getElementById(id);
    const money = (n) => {
      const x = Number(n || 0);
      return x.toLocaleString(undefined, { style: 'currency', currency: 'USD' });
    };

    function setMsg(el, text, kind = 'err') {
      if (!el) return;
      el.classList.remove('hide', 'err', 'ok');
      el.classList.add(kind === 'ok' ? 'ok' : 'err');
      el.textContent = text;
      setTimeout(() => el.classList.add('hide'), 3500);
    }

    async function api(endpoint, method = 'GET', body = null) {
      const headers = { 'Content-Type': 'application/json' };
      if (state.token) headers['Authorization'] = `Bearer ${state.token}`;

      const res = await fetch(`${API_URL}${endpoint}`, {
        method,
        headers,
        body: body ? JSON.stringify(body) : null
      });

      // If backend returns HTML, your fallback is catching API routes.
      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const text = await res.text();
        throw new Error(`Expected JSON but got: ${ct}. First 60 chars: ${text.slice(0,60)}`);
      }

      const data = await res.json();

      if (res.status === 401) {
        logout();
        throw new Error(data?.error || 'Unauthorized');
      }

      if (!res.ok) {
        throw new Error(data?.error || 'Request failed');
      }

      return data;
    }

    function logout() {
      state.token = null;
      state.user = null;
      localStorage.removeItem('token');
      showAuth();
    }

    function showAuth() {
      $('authView').classList.remove('hide');
      $('appView').classList.add('hide');
    }
    function showApp() {
      $('authView').classList.add('hide');
      $('appView').classList.remove('hide');
    }

    function setTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tabName);
      });
      ['dashboard','recurring','planning'].forEach(n => {
        $(`tab-${n}`).classList.toggle('hide', n !== tabName);
      });
    }

    // =========================
    // Auth
    // =========================
    let isSignup = false;

    function syncAuthUI() {
      $('switchAuthBtn').textContent = isSignup ? 'Switch to Login' : 'Switch to Sign up';
      $('authSubmitBtn').textContent = isSignup ? 'Sign up' : 'Login';
      $('nameField').style.display = isSignup ? '' : 'none';
      $('authPassword').setAttribute('autocomplete', isSignup ? 'new-password' : 'current-password');
    }

    async function submitAuth() {
      const msg = $('authMsg');
      msg.classList.add('hide');

      const name = $('authName').value.trim();
      const email = $('authEmail').value.trim();
      const password = $('authPassword').value;

      try {
        if (!email || !password) throw new Error('Email and password are required');
        if (isSignup && password.length < 6) throw new Error('Password must be at least 6 characters');

        const endpoint = isSignup ? '/auth/signup' : '/auth/login';
        const payload = isSignup ? { name, email, password } : { email, password };

        const data = await api(endpoint, 'POST', payload);

        state.token = data.token;
        localStorage.setItem('token', state.token);

        // Some APIs return user info; if not, we’ll still render.
        state.user = data.user || { name: name || 'User', email };

        showApp();
        initApp();
      } catch (e) {
        setMsg(msg, e.message || 'Auth failed', 'err');
      }
    }

    // =========================
    // Dashboard rendering
    // =========================
    function renderHeader() {
      const today = new Date();
      const dateStr = today.toLocaleDateString(undefined, { weekday: 'long', year:'numeric', month:'long', day:'numeric' });
      $('todayLine').textContent = dateStr.toUpperCase();
      $('welcomeTitle').textContent = `Good ${today.getHours() < 12 ? 'morning' : (today.getHours()<18?'afternoon':'evening')}, ${state.user?.name || 'User'}`;
    }

    function renderMetrics() {
      const m = state.metrics || {};
      $('mAvailable').textContent = money(m.available);
      $('mSavings').textContent = money(m.savings);
      $('mBudget').textContent = money(m.budget);
      $('mSpent').textContent = money(m.spent);
      $('mCommitted').textContent = money(m.committed);
    }

    function filteredTransactions() {
      const { from, to } = state.period;
      if (!from && !to) return state.transactions;

      const fromT = from ? new Date(from).setHours(0,0,0,0) : null;
      const toT   = to   ? new Date(to).setHours(23,59,59,999) : null;

      return state.transactions.filter(tx => {
        const t = new Date(tx.date).getTime();
        if (fromT && t < fromT) return false;
        if (toT && t > toT) return false;
        return true;
      });
    }

    function renderRecent() {
      const list = $('recentList');
      const txs = filteredTransactions().slice(0, 7);

      $('txHint').textContent = `${filteredTransactions().length} total`;

      if (!txs.length) {
        list.innerHTML = `<div class="muted">No transactions yet</div>`;
        return;
      }

      list.innerHTML = txs.map(tx => {
        const amt = Number(tx.amount || 0);
        const kind = tx.type === 'income' ? 'good' : (tx.type === 'expense' ? 'bad' : 'neutral');
        const sign = tx.type === 'income' ? '+' : (tx.type === 'expense' ? '-' : '');
        const date = new Date(tx.date).toLocaleDateString();
        return `
          <div class="item">
            <div class="left">
              <div class="name">${escapeHtml(tx.category || 'Uncategorized')}</div>
              <div class="meta">${escapeHtml(tx.type || 'transaction')} • ${date}</div>
            </div>
            <div class="amount ${kind}">${sign}${money(Math.abs(amt))}</div>
          </div>
        `;
      }).join('');
    }

    function renderInsights() {
      const box = $('insightsBox');
      const insights = state.insights || [];
      $('aiStatus').textContent = insights.length ? 'AI: active' : 'AI: idle';

      if (!insights.length) {
        box.innerHTML = `<div class="muted">No insights yet. Add more transactions.</div>`;
        return;
      }

      box.innerHTML = insights.slice(0, 6).map(i => `
        <div class="item">
          <div class="left">
            <div class="name">${escapeHtml(i.title || 'Insight')}</div>
            <div class="meta">${escapeHtml(i.message || '')}</div>
          </div>
        </div>
      `).join('');
    }

    // Simple donut chart from category totals
    function renderDonut() {
      const canvas = $('donut');
      const ctx = canvas.getContext('2d');

      // Ensure crisp drawing
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.scale(dpr, dpr);

      const txs = filteredTransactions();
      const byCat = new Map();

      for (const tx of txs) {
        if (tx.type !== 'expense') continue;
        const c = (tx.category || 'Other').trim();
        byCat.set(c, (byCat.get(c) || 0) + Math.abs(Number(tx.amount || 0)));
      }

      const entries = [...byCat.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 7);
      const total = entries.reduce((s, [,v]) => s+v, 0);

      $('breakdownHint').textContent = total ? `${entries.length} categories` : 'No expense data';

      // Background
      ctx.clearRect(0,0,rect.width,rect.height);

      const cx = rect.width / 2;
      const cy = rect.height / 2;
      const rOuter = Math.min(rect.width, rect.height) * 0.33;
      const rInner = rOuter * 0.62;

      // draw ring base
      ctx.beginPath();
      ctx.arc(cx, cy, rOuter, 0, Math.PI*2);
      ctx.arc(cx, cy, rInner, 0, Math.PI*2, true);
      ctx.closePath();
      ctx.fillStyle = "rgba(255,255,255,0.06)";
      ctx.fill();

      if (!total) return;

      let start = -Math.PI / 2;

      // No custom colors (per your preference): we derive grayscale-ish slices.
      entries.forEach(([,v], idx) => {
        const frac = v/total;
        const end = start + frac * Math.PI * 2;

        ctx.beginPath();
        ctx.arc(cx, cy, rOuter, start, end);
        ctx.arc(cx, cy, rInner, end, start, true);
        ctx.closePath();

        // subtle varying alpha
        ctx.fillStyle = `rgba(216,166,42,${0.10 + idx*0.08})`;
        ctx.fill();

        start = end;
      });

      // Center label
      ctx.fillStyle = "rgba(255,255,255,0.85)";
      ctx.font = "600 14px ui-sans-serif, system-ui";
      ctx.textAlign = "center";
      ctx.fillText("Expenses", cx, cy - 6);
      ctx.fillStyle = "rgba(255,255,255,0.65)";
      ctx.font = "700 18px ui-sans-serif, system-ui";
      ctx.fillText(money(total), cx, cy + 18);
    }

    // =========================
    // Recurring rendering
    // =========================
    function renderRecurring() {
      const list = $('recurringList');
      const items = state.recurring || [];
      $('rHint').textContent = `${items.length} items`;

      if (!items.length) {
        list.innerHTML = `<div class="muted">No recurring expenses yet</div>`;
        return;
      }

      list.innerHTML = items.map(r => `
        <div class="item">
          <div class="left">
            <div class="name">${escapeHtml(r.name || 'Recurring')}</div>
            <div class="meta">${escapeHtml(r.frequency || 'monthly')} • ${money(r.amount)}</div>
          </div>
          <button class="btn danger" data-del-recurring="${r._id}">Delete</button>
        </div>
      `).join('');
    }

    // =========================
    // Budget rendering
    // =========================
    function renderBudgetSummary() {
      const box = $('budgetSummary');
      const m = state.metrics || {};
      box.innerHTML = `
        <div class="item">
          <div class="left">
            <div class="name">Monthly Budget</div>
            <div class="meta">Stored on server</div>
          </div>
          <div class="amount neutral">${money(m.budget)}</div>
        </div>
        <div class="item">
          <div class="left">
            <div class="name">Spent (This month)</div>
            <div class="meta">Expenses only</div>
          </div>
          <div class="amount bad">${money(m.spent)}</div>
        </div>
        <div class="item">
          <div class="left">
            <div class="name">Remaining</div>
            <div class="meta">Budget - spent</div>
          </div>
          <div class="amount good">${money((m.budget||0) - (m.spent||0))}</div>
        </div>
      `;
    }

    // =========================
    // Actions
    // =========================
    let txMode = 'expense';
    function setTxMode(mode) {
      txMode = mode;
      $('modeExpense').classList.toggle('active', mode === 'expense');
      $('modeIncome').classList.toggle('active', mode === 'income');
      $('modeSave').classList.toggle('active', mode === 'save');
    }

    async function addTransaction() {
      const msg = $('txMsg');
      msg.classList.add('hide');

      const category = $('txCategory').value.trim() || 'Other';
      const amount = Number($('txAmount').value);
      const date = $('txDate').value || new Date().toISOString().slice(0,10);
      const note = $('txNote').value.trim();

      try {
        if (!Number.isFinite(amount) || amount <= 0) throw new Error('Amount must be > 0');

        await api('/transactions', 'POST', {
          type: txMode,
          category,
          amount,
          date,
          note
        });

        $('txCategory').value = '';
        $('txAmount').value = '';
        $('txNote').value = '';

        setMsg(msg, 'Transaction saved', 'ok');

        await refreshAll(); // reload metrics + tx + insights
      } catch (e) {
        setMsg(msg, e.message || 'Failed to add transaction', 'err');
      }
    }

    async function addRecurring() {
      const msg = $('rMsg');
      msg.classList.add('hide');

      const name = $('rName').value.trim();
      const amount = Number($('rAmount').value);
      const frequency = $('rFrequency').value;
      const dueDay = $('rDueDay').value ? Number($('rDueDay').value) : undefined;

      try {
        if (!name) throw new Error('Name is required');
        if (!Number.isFinite(amount) || amount <= 0) throw new Error('Amount must be > 0');

        await api('/recurring', 'POST', { name, amount, frequency, dueDay });

        $('rName').value = '';
        $('rAmount').value = '';
        $('rDueDay').value = '';

        setMsg(msg, 'Recurring saved', 'ok');

        await refreshAll();
      } catch (e) {
        setMsg(msg, e.message || 'Failed to add recurring', 'err');
      }
    }

    async function deleteRecurring(id) {
      try {
        await api(`/recurring/${id}`, 'DELETE');
        await refreshAll();
      } catch (e) {
        alert(e.message || 'Failed to delete recurring');
      }
    }

    async function saveBudget() {
      const msg = $('bMsg');
      msg.classList.add('hide');

      const v = Number($('budgetValue').value);
      try {
        if (!Number.isFinite(v) || v < 0) throw new Error('Budget must be 0 or more');

        await api('/budget', 'POST', { monthlyBudget: v });
        setMsg(msg, 'Budget saved', 'ok');

        await refreshAll();
      } catch (e) {
        setMsg(msg, e.message || 'Failed to save budget', 'err');
      }
    }

    function exportData() {
      const txs = state.transactions || [];
      const rec = state.recurring || [];

      // Always provide CSV (works in Excel)
      const txRows = [
        ['type','category','amount','date','note'],
        ...txs.map(t => [t.type, t.category, t.amount, t.date, t.note || ''])
      ];

      const recRows = [
        ['name','amount','frequency','dueDay'],
        ...rec.map(r => [r.name, r.amount, r.frequency, r.dueDay || ''])
      ];

      // If XLSX is available, generate workbook.
      if (window.XLSX) {
        const wb = XLSX.utils.book_new();
        const ws1 = XLSX.utils.aoa_to_sheet(txRows);
        const ws2 = XLSX.utils.aoa_to_sheet(recRows);
        XLSX.utils.book_append_sheet(wb, ws1, 'Transactions');
        XLSX.utils.book_append_sheet(wb, ws2, 'Recurring');
        XLSX.writeFile(wb, 'vault_export.xlsx');
        return;
      }

      // Fallback CSV
      downloadCSV('transactions.csv', txRows);
      downloadCSV('recurring.csv', recRows);
      alert('Exported CSV files (Excel can open them).');
    }

    function downloadCSV(filename, rows) {
      const csv = rows.map(r =>
        r.map(v => {
          const s = String(v ?? '');
          if (s.includes('"') || s.includes(',') || s.includes('\n')) return `"${s.replaceAll('"','""')}"`;
          return s;
        }).join(',')
      ).join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // =========================
    // Data loading
    // =========================
    async function refreshAll() {
      // Load everything needed for the full UI
      const [metrics, txResp, recurring, budget, insights] = await Promise.all([
        api('/dashboard/metrics'),
        api('/transactions'),
        api('/recurring'),
        api('/budget'),
        api('/insights')
      ]);

      state.metrics = metrics;

      // Support BOTH response shapes: {transactions:[...]} or [...]
      state.transactions = Array.isArray(txResp) ? txResp : (txResp.transactions || []);

      state.recurring = Array.isArray(recurring) ? recurring : (recurring.recurring || []);
      state.insights = Array.isArray(insights) ? insights : (insights.insights || []);

      // budget endpoint returns object
      if (budget && typeof budget === 'object') {
        // if you want to display it directly in planning
        $('budgetValue').value = (budget.monthlyBudget ?? state.metrics?.budget ?? 0);
      }

      renderMetrics();
      renderRecent();
      renderDonut();
      renderRecurring();
      renderBudgetSummary();
      renderInsights();
    }

    function initDates() {
      const today = new Date().toISOString().slice(0,10);
      $('txDate').value = today;

      // Default period: current month
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10);
      const end = new Date(now.getFullYear(), now.getMonth()+1, 0).toISOString().slice(0,10);

      $('fromDate').value = start;
      $('toDate').value = end;

      state.period.from = start;
      state.period.to = end;
    }

    function applyPeriod() {
      state.period.from = $('fromDate').value || null;
      state.period.to = $('toDate').value || null;
      renderRecent();
      renderDonut();
    }

    function resetPeriod() {
      state.period.from = null;
      state.period.to = null;
      $('fromDate').value = '';
      $('toDate').value = '';
      renderRecent();
      renderDonut();
    }

    // =========================
    // Safety
    // =========================
    function escapeHtml(str) {
      return String(str ?? '').replace(/[&<>"']/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[s]));
    }

    // =========================
    // Boot
    // =========================
    async function initApp() {
      renderHeader();
      initDates();
      setTab('dashboard');
      await refreshAll();
    }

    // Event wiring
    document.addEventListener('click', async (e) => {
      const tab = e.target.closest('.tab');
      if (tab) setTab(tab.dataset.tab);

      if (e.target.id === 'logoutBtn') logout();
      if (e.target.id === 'exportBtn') exportData();

      if (e.target.id === 'switchAuthBtn') {
        isSignup = !isSignup;
        syncAuthUI();
      }

      if (e.target.id === 'authSubmitBtn') submitAuth();

      if (e.target.id === 'modeExpense') setTxMode('expense');
      if (e.target.id === 'modeIncome') setTxMode('income');
      if (e.target.id === 'modeSave') setTxMode('save');

      if (e.target.id === 'addTxBtn') addTransaction();
      if (e.target.id === 'addRecurringBtn') addRecurring();
      if (e.target.id === 'saveBudgetBtn') saveBudget();

      if (e.target.id === 'applyPeriodBtn') applyPeriod();
      if (e.target.id === 'resetPeriodBtn') resetPeriod();

      const del = e.target.getAttribute('data-del-recurring');
      if (del) deleteRecurring(del);
    });

    document.addEventListener('keydown', (e) => {
      // Enter key on auth form
      if ($('authView') && !$('authView').classList.contains('hide')) {
        if (e.key === 'Enter') submitAuth();
      }
    });

    // Startup
    (function boot() {
      syncAuthUI();

      if (state.token) {
        // Token exists — show app and load
        state.user = { name: 'User' }; // optional; backend can also return user from auth endpoints
        showApp();
        initApp().catch(err => {
          console.error(err);
          logout();
        });
      } else {
        showAuth();
      }
    })();
  </script>
</body>
</html>
